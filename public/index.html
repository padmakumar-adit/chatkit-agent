<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Knowledge Agent â€” Streaming</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0f1720; --panel:#0b1220; --muted:#9aa6b2; --accent:#2563eb; --ai-bg:#0b1228; --user-bg:#1f2937; --ai-text:#e6eef8; --user-text:#e8f0ff;}
    [data-theme="light"]{ --bg:#f4f6f8; --panel:#ffffff; --muted:#6b7280; --accent:#0b74ff; --ai-bg:#ffffff; --user-bg:#e6f0ff; --ai-text:#0b1220; --user-text:#0b1220; }
    html,body{height:100%;margin:0;font-family:Inter, Arial, sans-serif;background:var(--bg);color:var(--ai-text)}
    .app{max-width:980px;margin:0 auto;height:100vh;display:flex;flex-direction:column;padding:18px;box-sizing:border-box}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#1e3a8a,#0ea5e9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
    .title{font-size:16px;font-weight:600}
    .controls{display:flex;gap:8px;align-items:center}
    .toggle{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .panel{flex:1;display:flex;flex-direction:column;background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .messages{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:12px}
    .msg-row{display:flex;gap:12px;align-items:flex-end}
    .msg-row.ai{align-items:flex-start}
    .avatar{width:40px;height:40px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
    .avatar.ai{background:linear-gradient(135deg,#0ea5e9,#06b6d4)}
    .avatar.user{background:linear-gradient(135deg,#7c3aed,#a78bfa)}
    .bubble{max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.4;white-space:pre-wrap;box-shadow:0 2px 6px rgba(2,6,23,0.4)}
    .bubble.ai{background:var(--ai-bg);color:var(--ai-text);border:1px solid rgba(255,255,255,0.03);border-top-left-radius:4px}
    .bubble.user{background:var(--user-bg);color:var(--user-text);align-self:flex-end;border-top-right-radius:4px}
    .meta{font-size:12px;color:var(--muted);margin-top:6px;display:flex;gap:8px;align-items:center}
    .input-area{display:flex;gap:8px;padding-top:12px}
    .input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--ai-text);}
    .send{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .typing{height:14px;padding:6px 10px;border-radius:6px;background:rgba(255,255,255,0.03);display:inline-block}
    .dots span{display:inline-block;width:6px;height:6px;margin:0 2px;background:var(--muted);border-radius:50%;opacity:.6;animation:dots 1s infinite}
    @keyframes dots{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
    pre {background:#071026;color:#dbeafe;padding:10px;border-radius:8px;overflow:auto}
    code {background:rgba(0,0,0,0.15);padding:2px 6px;border-radius:6px}
    .feedback{display:flex;gap:8px;margin-top:8px;align-items:center}
    .fb-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .theme-toggle{border-radius:8px;padding:6px 8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body data-theme="dark">
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo">KB</div>
        <div>
          <div class="title">Call Intelligence â€” Knowledge Agent</div>
          <div class="small">Answers from your product docs</div>
        </div>
      </div>
      <div class="controls">
        <button class="toggle" id="themeBtn">Toggle theme</button>
        <button class="toggle" id="clearBtn">Clear</button>
      </div>
    </div>

    <div class="panel">
      <div class="messages" id="messages"></div>

      <div class="input-area">
        <input id="input" class="input" placeholder="Ask a question..." />
        <button id="sendBtn" class="send">Send</button>
      </div>
    </div>
  </div>

<script>
/* Markdown renderer (simple) */
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function renderMarkdown(md){
  if(!md) return "";
  md = md.replace(/```([\s\S]*?)```/g, function(m, code){ return '<pre><code>'+escapeHtml(code)+'</code></pre>'; });
  md = md.replace(/^### (.*$)/gim,'<h3>$1</h3>');
  md = md.replace(/^## (.*$)/gim,'<h2>$1</h2>');
  md = md.replace(/^# (.*$)/gim,'<h1>$1</h1>');
  md = md.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  md = md.replace(/\*(.*?)\*/g,'<em>$1</em>');
  md = md.replace(/`([^`]+)`/g,'<code>$1</code>');
  md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  md = md.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>');
  md = md.replace(/(<li>.*<\/li>)/g, function(m){ return '<ul>'+m+'</ul>'; });
  md = md.replace(/\n{2,}/g, '</p><p>');
  md = '<p>' + md + '</p>';
  return md;
}

/* UI */
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const themeBtn = document.getElementById('themeBtn');
const clearBtn = document.getElementById('clearBtn');
let theme='dark';
themeBtn.onclick = ()=>{ theme=(theme==='dark')?'light':'dark'; document.body.setAttribute('data-theme', theme); }
clearBtn.onclick = ()=>{ messagesEl.innerHTML=''; }

/* Add user message */
function addUser(text){
  const row=document.createElement('div'); row.className='msg-row user';
  const bubble=document.createElement('div'); bubble.className='bubble user'; bubble.innerText=text;
  row.style.justifyContent='flex-end';
  row.appendChild(bubble); messagesEl.appendChild(row); messagesEl.scrollTop=messagesEl.scrollHeight;
}

/* Add AI streaming bubble (returns container elements) */
function addAiStreaming(){
  const row=document.createElement('div'); row.className='msg-row ai';
  const avatar=document.createElement('div'); avatar.className='avatar ai'; avatar.innerText='KB';
  const container=document.createElement('div');
  const bubble=document.createElement('div'); bubble.className='bubble ai';
  const streamDiv=document.createElement('div'); streamDiv.className='stream';
  bubble.appendChild(streamDiv);
  container.appendChild(bubble);
  // meta + feedback placeholder
  const metaEl=document.createElement('div'); metaEl.className='meta small'; metaEl.innerText='';
  container.appendChild(metaEl);
  const feedbackDiv=document.createElement('div'); feedbackDiv.className='feedback';
  const up=document.createElement('button'); up.className='fb-btn'; up.innerText='ðŸ‘';
  const down=document.createElement('button'); down.className='fb-btn'; down.innerText='ðŸ‘Ž';
  feedbackDiv.appendChild(up); feedbackDiv.appendChild(down);
  container.appendChild(feedbackDiv);

  row.appendChild(avatar); row.appendChild(container);
  messagesEl.appendChild(row); messagesEl.scrollTop=messagesEl.scrollHeight;
  return { row, streamDiv, metaEl, up, down };
}

/* Streaming send */
async function send(){
  const text = inputEl.value.trim();
  if(!text) return;
  addUser(text);
  inputEl.value='';
  const { streamDiv, up, down, metaEl } = addAiStreaming();

  // streaming via fetch + reader
  const resp = await fetch('/api/stream?q='+encodeURIComponent(text));
  if(!resp.ok){ streamDiv.innerText='Server error'; return; }
  const reader = resp.body.getReader();
  const dec = new TextDecoder();
  let acc = '';

  function appendChunk(s){
    // append raw text to streamDiv as plain text to keep streaming smooth
    streamDiv.textContent += s;
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  while(true){
    const { value, done } = await reader.read();
    if(done) break;
    const chunk = dec.decode(value);
    // SSE may deliver multiple events; split on double newline
    const parts = chunk.split('\n\n');
    for(const p of parts){
      if(p.startsWith('data: ')){
        const json = p.slice(6).trim();
        try{
          const obj = JSON.parse(json);
          if(obj.type === 'delta'){
            appendChunk(obj.text);
            acc += obj.text;
          } else if(obj.type === 'done'){
            // final text provided
            acc = obj.text || acc;
          }
        }catch(e){}
      }
    }
  }

  // replace streamed plain text with rendered markdown
  streamDiv.innerHTML = renderMarkdown(acc);

  // attach feedback handlers (send message id if needed)
  up.onclick = ()=> sendFeedback(null, true);
  down.onclick = ()=> sendFeedback(null, false);
}

/* feedback */
async function sendFeedback(message_id, thumbs_up){
  try{
    await fetch('/api/feedback', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message_id, thumbs_up }) });
    alert('Thanks for the feedback');
  }catch(e){
    console.error('feedback error', e);
  }
}

sendBtn.onclick = send;
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
</script>
</body>
</html>
